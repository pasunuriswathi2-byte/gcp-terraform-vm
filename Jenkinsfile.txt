pipeline {
    agent any

    // Parameter for user to enter VM name
    parameters {
        string(
            name: 'VM_NAME',
            defaultValue: '',
            description: 'Enter the name of the VM to create'
        )
    }

    environment {
        GCP_SA_JSON = 'gcp-sa.json'
    }

    stages {
        stage('Checkout') {
            steps {
                checkout(scm)
            }
        }

        stage('Prepare credentials') {
            steps {
                withCredentials([file(credentialsId: 'gcp-sa-key', variable: 'GCP_SA_FILE')]) {
                    sh '''
                        cp "$GCP_SA_FILE" ${GCP_SA_JSON}
                        chmod 600 ${GCP_SA_JSON}
                    '''
                }
            }
        }

        stage('Terraform Init') {
            steps {
                withEnv(["GOOGLE_APPLICATION_CREDENTIALS=${GCP_SA_JSON}"]) {
                    sh 'terraform init -input=false'
                }
            }
        }

        stage('Terraform Plan') {
            steps {
                withEnv(["GOOGLE_APPLICATION_CREDENTIALS=${GCP_SA_JSON}"]) {
                    sh """
                        terraform plan -input=false -out=tfplan \
                        -var="vm_name=${params.VM_NAME}"
                    """
                }
            }
        }

        stage('Terraform Apply') {
            steps {
                input message: "Apply terraform changes?", ok: "Apply"
                withEnv(["GOOGLE_APPLICATION_CREDENTIALS=${GCP_SA_JSON}"]) {
                    sh 'terraform apply -input=false tfplan'
                }
            }
        }
    }

    post {
        always {
            sh 'rm -f ${GCP_SA_JSON} tfplan'
        }
    }
}
